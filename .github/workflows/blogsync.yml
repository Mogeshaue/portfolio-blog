name: Sync Blogs from Blogs-dev

on:
  # Trigger when a push happens to Blogs-dev repository
  repository_dispatch:
    types: [blog-update]
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run daily to check for updates
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC

jobs:
  sync-blogs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Portfolio Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: portfolio
      
      - name: Checkout Blogs-dev Repository
        uses: actions/checkout@v4
        with:
          repository: Mogeshaue/Blogs-dev
          token: ${{ secrets.GITHUB_TOKEN }}
          path: blogs-dev
      
      - name: Sync Blog Posts
        run: |
          # Remove old sample blogs (optional - comment out if you want to keep them)
          rm -rf portfolio/Astro-template/src/content/blog/welcome-to-my-blog.md
          rm -rf portfolio/Astro-template/src/content/blog/authentication-bypass-bug-bounty.md
          rm -rf portfolio/Astro-template/src/content/blog/frida-ssl-pinning-bypass.md
          
          # Copy all non-draft blogs from Blogs-dev
          find blogs-dev/src/content/blog -mindepth 1 -maxdepth 1 -type d ! -name "drafts" -exec cp -r {} portfolio/Astro-template/src/content/blog/ \;
          
          # Copy individual markdown files if any
          find blogs-dev/src/content/blog -maxdepth 1 -type f -name "*.md" -exec cp {} portfolio/Astro-template/src/content/blog/ \;
      
      - name: Check for changes
        id: verify-diff
        run: |
          cd portfolio
          git diff --exit-code || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit and Push Changes
        if: steps.verify-diff.outputs.changed == 'true'
        run: |
          cd portfolio
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add Astro-template/src/content/blog/
          git commit -m "chore: sync blogs from Blogs-dev repository"
          git push
      
      - name: Trigger Vercel Deployment
        if: steps.verify-diff.outputs.changed == 'true'
        run: |
          echo "âœ… Blogs synced! Vercel will auto-deploy the changes."
